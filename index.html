<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecureTest - Anti-Cheat Test Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
        }

        .login-form {
            max-width: 400px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #f44336 0%, #da190b 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            color: white;
        }

        .btn-full-width {
            width: 100%;
        }

        .dashboard {
            display: none;
        }

        .dashboard.active {
            display: block;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e1e5e9;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .avatar {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 20px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }

        .tab {
            padding: 12px 24px;
            background: #f8f9fa;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .question-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .options-container {
            margin-top: 15px;
        }

        .option-input {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .test-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .test-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 10px;
        }

        .test-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .fullscreen-warning {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            color: white;
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            flex-direction: column;
            text-align: center;
        }

        .test-interface {
            display: none;
        }

        .test-interface.active {
            display: block;
        }

        .test-header-bar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 15px 15px 0 0;
        }

        .timer {
            font-size: 24px;
            font-weight: bold;
        }

        .test-content {
            padding: 30px;
        }

        .question {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 25px;
            border-left: 4px solid #667eea;
        }

        .question h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 18px;
        }

        .question-options {
            margin-top: 15px;
        }

        .option {
            margin-bottom: 10px;
        }

        .option input {
            margin-right: 10px;
        }

        .option label {
            cursor: pointer;
        }

        .navigation {
            text-align: center;
            margin-top: 30px;
        }

        .blocked-message {
            text-align: center;
            color: #dc3545;
            background: #f8d7da;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #f5c6cb;
        }

        .security-warning {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #ffeaa7;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .recording {
            animation: pulse 2s infinite;
        }

        .violation-warning {
            background: #dc3545;
            color: white;
            padding: 10px;
            text-align: center;
            font-weight: bold;
            margin-bottom: 20px;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="fullscreen-warning" id="fullscreenWarning">
        <h2>‚ö†Ô∏è Security Violation Detected</h2>
        <p>Your test has been automatically submitted due to using prohibited keys.</p>
        <p>You have been blocked from accessing this platform.</p>
    </div>

    <div class="container">
        <div class="header">
            <h1>üõ°Ô∏èEGC SecureTest</h1>
            <p>EntroGroup & Company | Developed by Nishant</p>
        </div>

        <!-- Login Interface -->
        <div id="loginInterface" class="card login-form">
            <h2 style="text-align: center; margin-bottom: 30px; color: #333;">Login to Platform</h2>


            <div class="form-group">
                <label for="loginRole">Login As:</label>
                <select id="loginRole" class="form-control">
                    <option value="">Select</option>
                    <option value="user">Intern</option>
                    <option value="admin">Administrator</option>
                </select>
            </div>

            <div class="form-group">
                <label for="loginId">User ID:</label>
                <input type="text" id="loginId" class="form-control" placeholder="Enter your ID" required>
            </div>

            <div class="form-group">
                <label for="loginPass">Password:</label>
                <input type="password" id="loginPass" class="form-control" placeholder="Enter your password" required>
            </div>

            <button onclick="login()" class="btn btn-primary btn-full-width">üîê Secure Login</button>

       
        </div>

        <!-- Admin Dashboard -->
        <div id="adminDashboard" class="dashboard">
            <div class="card">
                <div class="dashboard-header">
                    <div class="user-info">
                        <div class="avatar">A</div>
                        <div>
                            <h3>Admin Dashboard</h3>
                            <p>Manage tests and users</p>
                        </div>
                    </div>
                    <button onclick="logout()" class="btn btn-danger">Logout</button>
                </div>

                <div class="tabs">
                    <div class="tab active" onclick="switchTab('tests')">üìù Manage Tests</div>
                    <div class="tab" onclick="switchTab('users')">üë• Manage Users</div>
                    <div class="tab" onclick="switchTab('results')">üìä View Results</div>
                </div>

                <!-- Tests Tab -->
                <div id="testsTab" class="tab-content active">
                    <div class="grid">
                        <div class="card">
                            <h3>Create New Test</h3>
                            <div class="form-group">
                                <label>Test Name:</label>
                                <input type="text" id="testName" class="form-control" placeholder="Enter test name">
                            </div>
                            <div class="form-group">
                                <label>Time Limit (minutes):</label>
                                <input type="number" id="testTime" class="form-control" value="60" min="1">
                            </div>
                            <button onclick="createTest()" class="btn btn-success btn-full-width">Create Test</button>
                        </div>

                        <div class="card">
                            <h3>Add Question</h3>
                            <div class="form-group">
                                <label>Select Test:</label>
                                <select id="questionTestSelect" class="form-control">
                                    <option value="">Select a test</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Question Type:</label>
                                <select id="questionType" class="form-control" onchange="updateQuestionForm()">
                                    <option value="mcq">Multiple Choice (MCQ)</option>
                                    <option value="msq">Multiple Select (MSQ)</option>
                                    <option value="fillup">Fill in the Blank</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Question Text:</label>
                                <textarea id="questionText" class="form-control" rows="3" placeholder="Enter your question"></textarea>
                            </div>
                            <div id="optionsContainer">
                                <label>Options:</label>
                                <div class="options-container">
                                    <div class="option-input">
                                        <input type="checkbox" id="opt1_correct">
                                        <input type="text" id="opt1_text" class="form-control" placeholder="Option 1">
                                        <label for="opt1_correct">Correct</label>
                                    </div>
                                    <div class="option-input">
                                        <input type="checkbox" id="opt2_correct">
                                        <input type="text" id="opt2_text" class="form-control" placeholder="Option 2">
                                        <label for="opt2_correct">Correct</label>
                                    </div>
                                    <div class="option-input">
                                        <input type="checkbox" id="opt3_correct">
                                        <input type="text" id="opt3_text" class="form-control" placeholder="Option 3">
                                        <label for="opt3_correct">Correct</label>
                                    </div>
                                    <div class="option-input">
                                        <input type="checkbox" id="opt4_correct">
                                        <input type="text" id="opt4_text" class="form-control" placeholder="Option 4">
                                        <label for="opt4_correct">Correct</label>
                                    </div>
                                </div>
                            </div>
                            <div id="fillupContainer" style="display: none;">
                                <label>Correct Answer:</label>
                                <input type="text" id="fillupAnswer" class="form-control" placeholder="Enter correct answer">
                            </div>
                            <button onclick="addQuestion()" class="btn btn-primary btn-full-width">Add Question</button>
                        </div>
                    </div>

                    <div class="card">
                        <h3>Existing Tests</h3>
                        <div id="testsList"></div>
                    </div>
                </div>

                <!-- Users Tab -->
                <div id="usersTab" class="tab-content">
                    <div class="grid">
                        <div class="card">
                            <h3>Create User Account</h3>
                            <div class="form-group">
                                <label>User ID:</label>
                                <input type="text" id="newUserId" class="form-control" placeholder="Enter user ID">
                            </div>
                            <div class="form-group">
                                <label>Password:</label>
                                <input type="text" id="newUserPass" class="form-control" placeholder="Enter password">
                            </div>
                            <div class="form-group">
                                <label>Full Name:</label>
                                <input type="text" id="newUserName" class="form-control" placeholder="Enter full name">
                            </div>
                            <button onclick="createUser()" class="btn btn-success btn-full-width">Create User</button>
                        </div>
                    </div>

                    <div class="card">
                        <h3>User Management</h3>
                        <div id="usersList"></div>
                    </div>
                </div>

                <!-- Results Tab -->
                <div id="resultsTab" class="tab-content">
                    <div class="card">
                        <h3>Test Results</h3>
                        <div id="resultsList"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- User Dashboard -->
        <div id="userDashboard" class="dashboard">
            <div class="card">
                <div class="dashboard-header">
                    <div class="user-info">
                        <div class="avatar">U</div>
                        <div>
                            <h3 id="userName">User Dashboard</h3>
                            <p>Available tests and results</p>
                        </div>
                    </div>
                    <button onclick="logout()" class="btn btn-danger">Logout</button>
                </div>

                <div id="userContent">
                    <div class="security-warning">
                        <strong>üõ°Ô∏è Anti-Cheat System Active:</strong> Using Ctrl key during test will immediately submit your test and block your account permanently.
                    </div>

                    <div class="card">
                        <h3>Available Tests</h3>
                        <div id="availableTests"></div>
                    </div>

                    <div class="card">
                        <h3>Test Results</h3>
                        <div id="userResults"></div>
                    </div>
                </div>

                <div id="blockedContent" style="display: none;">
                    <div class="blocked-message">
                        <h3>‚ùå Account Blocked</h3>
                        <p>Your account has been permanently blocked due to security violations during testing.</p>
                        <p>Contact the administrator for assistance.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Test Interface -->
        <div id="testInterface" class="dashboard">
            <div class="card">
                <div class="test-header-bar">
                    <div>
                        <h2 id="testTitle">Test Title</h2>
                        <span id="testProgress">Question 1 of 10</span>
                    </div>
                    <div class="timer recording" id="timer">60:00</div>
                </div>

                <div id="securityAlert" class="violation-warning" style="display: none;">
                    ‚ö†Ô∏è WARNING: Do not use Ctrl key or your test will be submitted immediately!
                </div>

                <div class="test-content">
                    <div id="testQuestions"></div>
                    
                    <div class="navigation">
                        <button onclick="submitTest()" class="btn btn-success">üöÄ Submit Test</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize data storage
        let currentUser = null;
        let currentTest = null;
        let testStartTime = null;
        let timerInterval = null;
        let securityViolated = false;

        // Initialize with demo data
        if (!localStorage.getItem('tests')) {
            localStorage.setItem('tests', JSON.stringify([]));
        }
        if (!localStorage.getItem('users')) {
            const demoUsers = [
                { id: 'admin', password: 'nishant5806', role: 'admin', name: 'Administrator' },
                { id: 'user001', password: 'pass123', role: 'user', name: 'Demo User', blocked: false }
            ];
            localStorage.setItem('users', JSON.stringify(demoUsers));
        }
        if (!localStorage.getItem('results')) {
            localStorage.setItem('results', JSON.stringify([]));
        }

        function login() {
            const role = document.getElementById('loginRole').value;
            const id = document.getElementById('loginId').value;
            const password = document.getElementById('loginPass').value;

            if (!id || !password) {
                alert('Please enter both ID and password');
                return;
            }

            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const user = users.find(u => u.id === id && u.password === password && u.role === role);

            if (!user) {
                alert('Invalid credentials');
                return;
            }

            if (user.blocked && role === 'user') {
                alert('Your account has been blocked due to security violations');
                return;
            }

            currentUser = user;
            document.getElementById('loginInterface').style.display = 'none';
            
            if (role === 'admin') {
                document.getElementById('adminDashboard').classList.add('active');
                loadAdminData();
            } else {
                document.getElementById('userDashboard').classList.add('active');
                document.getElementById('userName').textContent = user.name || user.id;
                loadUserData();
            }
        }

        function logout() {
            currentUser = null;
            document.querySelectorAll('.dashboard').forEach(d => d.classList.remove('active'));
            document.getElementById('loginInterface').style.display = 'block';
            document.getElementById('loginId').value = '';
            document.getElementById('loginPass').value = '';
            if (timerInterval) clearInterval(timerInterval);
            
            // Clean up test interface
            currentTest = null;
            securityViolated = false;
            document.removeEventListener('keydown', handleKeyPress);
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        function createTest() {
            const name = document.getElementById('testName').value;
            const time = parseInt(document.getElementById('testTime').value);

            if (!name || !time) {
                alert('Please enter test name and time limit');
                return;
            }

            const tests = JSON.parse(localStorage.getItem('tests') || '[]');
            const newTest = {
                id: Date.now().toString(),
                name: name,
                timeLimit: time,
                questions: [],
                createdBy: currentUser.id,
                createdAt: new Date().toISOString()
            };

            tests.push(newTest);
            localStorage.setItem('tests', JSON.stringify(tests));

            document.getElementById('testName').value = '';
            document.getElementById('testTime').value = '60';
            
            loadAdminData();
            alert('Test created successfully!');
        }

        function updateQuestionForm() {
            const questionType = document.getElementById('questionType').value;
            const optionsContainer = document.getElementById('optionsContainer');
            const fillupContainer = document.getElementById('fillupContainer');

            if (questionType === 'fillup') {
                optionsContainer.style.display = 'none';
                fillupContainer.style.display = 'block';
            } else {
                optionsContainer.style.display = 'block';
                fillupContainer.style.display = 'none';
                
                // Update checkboxes for MCQ vs MSQ
                const checkboxes = optionsContainer.querySelectorAll('input[type="checkbox"]');
                if (questionType === 'mcq') {
                    checkboxes.forEach(cb => cb.type = 'radio');
                    checkboxes.forEach(cb => cb.name = 'correctOption');
                } else {
                    checkboxes.forEach(cb => cb.type = 'checkbox');
                    checkboxes.forEach(cb => cb.name = '');
                }
            }
        }

        function addQuestion() {
            const testId = document.getElementById('questionTestSelect').value;
            const questionType = document.getElementById('questionType').value;
            const questionText = document.getElementById('questionText').value;

            if (!testId || !questionText) {
                alert('Please select a test and enter question text');
                return;
            }

            const tests = JSON.parse(localStorage.getItem('tests') || '[]');
            const test = tests.find(t => t.id === testId);

            if (!test) {
                alert('Test not found');
                return;
            }

            const question = {
                id: Date.now().toString(),
                type: questionType,
                text: questionText,
                options: [],
                correctAnswer: null
            };

            if (questionType === 'fillup') {
                question.correctAnswer = document.getElementById('fillupAnswer').value;
            } else {
                for (let i = 1; i <= 4; i++) {
                    const optText = document.getElementById(`opt${i}_text`).value;
                    const isCorrect = document.getElementById(`opt${i}_correct`).checked;
                    
                    if (optText) {
                        question.options.push({
                            id: i,
                            text: optText,
                            correct: isCorrect
                        });
                    }
                }
            }

            test.questions.push(question);
            localStorage.setItem('tests', JSON.stringify(tests));

            // Clear form
            document.getElementById('questionText').value = '';
            document.getElementById('fillupAnswer').value = '';
            for (let i = 1; i <= 4; i++) {
                document.getElementById(`opt${i}_text`).value = '';
                document.getElementById(`opt${i}_correct`).checked = false;
            }

            loadAdminData();
            alert('Question added successfully!');
        }

        function createUser() {
            const id = document.getElementById('newUserId').value;
            const password = document.getElementById('newUserPass').value;
            const name = document.getElementById('newUserName').value;

            if (!id || !password || !name) {
                alert('Please fill all fields');
                return;
            }

            const users = JSON.parse(localStorage.getItem('users') || '[]');
            
            if (users.find(u => u.id === id)) {
                alert('User ID already exists');
                return;
            }

            const newUser = {
                id: id,
                password: password,
                name: name,
                role: 'user',
                blocked: false,
                createdAt: new Date().toISOString()
            };

            users.push(newUser);
            localStorage.setItem('users', JSON.stringify(users));

            document.getElementById('newUserId').value = '';
            document.getElementById('newUserPass').value = '';
            document.getElementById('newUserName').value = '';

            loadAdminData();
            alert('User created successfully!');
        }

        function deleteTest(testId) {
            if (confirm('Are you sure you want to delete this test?')) {
                const tests = JSON.parse(localStorage.getItem('tests') || '[]');
                const updatedTests = tests.filter(t => t.id !== testId);
                localStorage.setItem('tests', JSON.stringify(updatedTests));
                loadAdminData();
            }
        }

        function blockUser(userId) {
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const user = users.find(u => u.id === userId);
            if (user) {
                user.blocked = true;
                localStorage.setItem('users', JSON.stringify(users));
                loadAdminData();
                alert('User blocked successfully');
            }
        }

        function unblockUser(userId) {
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const user = users.find(u => u.id === userId);
            if (user) {
                user.blocked = false;
                localStorage.setItem('users', JSON.stringify(users));
                loadAdminData();
                alert('User unblocked successfully');
            }
        }

        function loadAdminData() {
            const tests = JSON.parse(localStorage.getItem('tests') || '[]');
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const results = JSON.parse(localStorage.getItem('results') || '[]');

            // Load test selector
            const testSelect = document.getElementById('questionTestSelect');
            testSelect.innerHTML = '<option value="">Select a test</option>';
            tests.forEach(test => {
                testSelect.innerHTML += `<option value="${test.id}">${test.name}</option>`;
            });

            // Load tests list
            const testsList = document.getElementById('testsList');
            testsList.innerHTML = '';
            tests.forEach(test => {
                testsList.innerHTML += `
                    <div class="test-item">
                        <div class="test-header">
                            <h4>${test.name}</h4>
                            <span>${test.timeLimit} minutes</span>
                        </div>
                        <p>Questions: ${test.questions.length}</p>
                        <p>Created: ${new Date(test.createdAt).toLocaleDateString()}</p>
                        <div class="test-actions">
                            <button onclick="deleteTest('${test.id}')" class="btn btn-danger">Delete</button>
                        </div>
                    </div>
                `;
            });

            // Load users list
            const usersList = document.getElementById('usersList');
            usersList.innerHTML = '';
            users.filter(u => u.role === 'user').forEach(user => {
                usersList.innerHTML += `
                    <div class="test-item">
                        <div class="test-header">
                            <h4>${user.name}</h4>
                            <span>ID: ${user.id}</span>
                        </div>
                        <p>Status: ${user.blocked ? 'üî¥ Blocked' : 'üü¢ Active'}</p>
                        <p>Created: ${new Date(user.createdAt).toLocaleDateString()}</p>
                        <div class="test-actions">
                            ${user.blocked ? 
                                `<button onclick="unblockUser('${user.id}')" class="btn btn-success">Unblock</button>` :
                                `<button onclick="blockUser('${user.id}')" class="btn btn-warning">Block</button>`}
                        </div>
                    </div>
                `;
            });

            // Load results list
            const resultsList = document.getElementById('resultsList');
            resultsList.innerHTML = '';
            results.forEach(result => {
                const test = tests.find(t => t.id === result.testId);
                const user = users.find(u => u.id === result.userId);
                resultsList.innerHTML += `
                    <div class="test-item">
                        <div class="test-header">
                            <h4>${test ? test.name : 'Unknown Test'}</h4>
                            <span>Score: ${result.score}%</span>
                        </div>
                        <p>Student: ${user ? user.name : result.userId}</p>
                        <p>Submitted: ${new Date(result.submittedAt).toLocaleString()}</p>
                        <p>Time Taken: ${Math.floor(result.timeTaken / 60)}m ${result.timeTaken % 60}s</p>
                        ${result.securityViolation ? '<p style="color: red;">‚ö†Ô∏è Security Violation Detected</p>' : ''}
                    </div>
                `;
            });
        }

        function loadUserData() {
            if (currentUser.blocked) {
                document.getElementById('userContent').style.display = 'none';
                document.getElementById('blockedContent').style.display = 'block';
                return;
            }

            const tests = JSON.parse(localStorage.getItem('tests') || '[]');
            const results = JSON.parse(localStorage.getItem('results') || '[]');
            const userResults = results.filter(r => r.userId === currentUser.id);

            // Load available tests
            const availableTests = document.getElementById('availableTests');
            availableTests.innerHTML = '';
            
            tests.forEach(test => {
                const hasAttempted = userResults.find(r => r.testId === test.id);
                if (!hasAttempted) {
                    availableTests.innerHTML += `
                        <div class="test-item">
                            <div class="test-header">
                                <h4>${test.name}</h4>
                                <span>${test.timeLimit} minutes</span>
                            </div>
                            <p>Questions: ${test.questions.length}</p>
                            <div class="test-actions">
                                <button onclick="startTest('${test.id}')" class="btn btn-primary">Start Test</button>
                            </div>
                        </div>
                    `;
                }
            });

            if (availableTests.innerHTML === '') {
                availableTests.innerHTML = '<p>No tests available or all tests completed.</p>';
            }

            // Load user results
            const userResultsDiv = document.getElementById('userResults');
            userResultsDiv.innerHTML = '';
            
            userResults.forEach(result => {
                const test = tests.find(t => t.id === result.testId);
                userResultsDiv.innerHTML += `
                    <div class="test-item">
                        <div class="test-header">
                            <h4>${test ? test.name : 'Unknown Test'}</h4>
                            <span>Score: ${result.score}%</span>
                        </div>
                        <p>Submitted: ${new Date(result.submittedAt).toLocaleString()}</p>
                        <p>Time Taken: ${Math.floor(result.timeTaken / 60)}m ${result.timeTaken % 60}s</p>
                        ${result.securityViolation ? '<p style="color: red;">‚ö†Ô∏è Security Violation</p>' : ''}
                    </div>
                `;
            });

            if (userResultsDiv.innerHTML === '') {
                userResultsDiv.innerHTML = '<p>No test results yet.</p>';
            }
        }

        function startTest(testId) {
            const tests = JSON.parse(localStorage.getItem('tests') || '[]');
            const test = tests.find(t => t.id === testId);
            
            if (!test || test.questions.length === 0) {
                alert('Test not found or has no questions');
                return;
            }

            if (confirm('‚ö†Ô∏è IMPORTANT: During the test, do not use the Ctrl key as it will automatically submit your test and block your account. Do you want to continue?')) {
                currentTest = test;
                testStartTime = Date.now();
                securityViolated = false;
                
                document.getElementById('userDashboard').classList.remove('active');
                document.getElementById('testInterface').classList.add('active');
                
                loadTestInterface();
                setupSecurityMonitoring();
            }
        }

        function loadTestInterface() {
            document.getElementById('testTitle').textContent = currentTest.name;
            document.getElementById('testProgress').textContent = `${currentTest.questions.length} Questions`;
            
            const questionsContainer = document.getElementById('testQuestions');
            questionsContainer.innerHTML = '';
            
            currentTest.questions.forEach((question, index) => {
                let questionHTML = `
                    <div class="question">
                        <h3>Question ${index + 1}: ${question.text}</h3>
                `;
                
                if (question.type === 'fillup') {
                    questionHTML += `
                        <input type="text" class="form-control" id="answer_${question.id}" placeholder="Enter your answer">
                    `;
                } else {
                    questionHTML += '<div class="question-options">';
                    question.options.forEach(option => {
                        const inputType = question.type === 'mcq' ? 'radio' : 'checkbox';
                        const name = question.type === 'mcq' ? `question_${question.id}` : '';
                        questionHTML += `
                            <div class="option">
                                <input type="${inputType}" id="opt_${question.id}_${option.id}" 
                                       name="${name}" value="${option.id}">
                                <label for="opt_${question.id}_${option.id}">${option.text}</label>
                            </div>
                        `;
                    });
                    questionHTML += '</div>';
                }
                
                questionHTML += '</div>';
                questionsContainer.innerHTML += questionHTML;
            });
            
            startTimer();
        }

        function startTimer() {
            let timeLeft = currentTest.timeLimit * 60; // Convert to seconds
            
            timerInterval = setInterval(() => {
                timeLeft--;
                
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                document.getElementById('timer').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    submitTest(true); // Auto-submit when time runs out
                }
            }, 1000);
        }

        function submitTest(autoSubmit = false) {
            if (!autoSubmit && !confirm('Are you sure you want to submit your test?')) {
                return;
            }

            clearInterval(timerInterval);
            const timeTaken = Math.floor((Date.now() - testStartTime) / 1000);
            
            // Collect answers
            const answers = {};
            currentTest.questions.forEach(question => {
                if (question.type === 'fillup') {
                    const answerInput = document.getElementById(`answer_${question.id}`);
                    answers[question.id] = answerInput ? answerInput.value.trim() : '';
                } else {
                    const selectedOptions = [];
                    question.options.forEach(option => {
                        const input = document.getElementById(`opt_${question.id}_${option.id}`);
                        if (input && input.checked) {
                            selectedOptions.push(option.id);
                        }
                    });
                    answers[question.id] = selectedOptions;
                }
            });
            
            // Calculate score
            let correctAnswers = 0;
            let totalQuestions = currentTest.questions.length;
            
            currentTest.questions.forEach(question => {
                const userAnswer = answers[question.id];
                
                if (question.type === 'fillup') {
                    if (userAnswer.toLowerCase() === question.correctAnswer.toLowerCase()) {
                        correctAnswers++;
                    }
                } else {
                    const correctOptions = question.options.filter(opt => opt.correct).map(opt => opt.id);
                    const userOptions = Array.isArray(userAnswer) ? userAnswer : [];
                    
                    if (correctOptions.length === userOptions.length && 
                        correctOptions.every(opt => userOptions.includes(opt))) {
                        correctAnswers++;
                    }
                }
            });
            
            const score = Math.round((correctAnswers / totalQuestions) * 100);
            
            // Save result
            const results = JSON.parse(localStorage.getItem('results') || '[]');
            const result = {
                id: Date.now().toString(),
                userId: currentUser.id,
                testId: currentTest.id,
                answers: answers,
                score: score,
                timeTaken: timeTaken,
                submittedAt: new Date().toISOString(),
                securityViolation: securityViolated,
                autoSubmitted: autoSubmit
            };
            
            results.push(result);
            localStorage.setItem('results', JSON.stringify(results));
            
            // If security violation, block user
            if (securityViolated) {
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                const user = users.find(u => u.id === currentUser.id);
                if (user) {
                    user.blocked = true;
                    localStorage.setItem('users', JSON.stringify(users));
                }
            }
            
            // Clean up test
            document.removeEventListener('keydown', handleKeyPress);
            document.getElementById('testInterface').classList.remove('active');
            
            if (securityViolated) {
                showSecurityViolation();
            } else {
                document.getElementById('userDashboard').classList.add('active');
                loadUserData();
                alert(`Test submitted successfully!\nYour Score: ${score}%\nTime Taken: ${Math.floor(timeTaken / 60)}m ${timeTaken % 60}s`);
            }
            
            // Reset test variables
            currentTest = null;
            securityViolated = false;
        }

        function setupSecurityMonitoring() {
            // Only monitor Ctrl key presses during test
            document.addEventListener('keydown', handleKeyPress);
        }

        function handleKeyPress(e) {
            if (!currentTest) return;
            
            // Only trigger violation on Ctrl key
            if (e.ctrlKey) {
                e.preventDefault();
                triggerSecurityViolation('Used Ctrl key during test');
                return;
            }
        }

        function triggerSecurityViolation(reason) {
            console.log('Security violation:', reason);
            securityViolated = true;
            document.getElementById('securityAlert').style.display = 'block';
            setTimeout(() => {
                submitTest(true); // Force submit after brief delay
            }, 1000);
        }

        function showSecurityViolation() {
            document.getElementById('fullscreenWarning').style.display = 'flex';
            setTimeout(() => {
                logout();
                document.getElementById('fullscreenWarning').style.display = 'none';
            }, 5000);
        }

        // Initialize question form
        updateQuestionForm();

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (timerInterval) clearInterval(timerInterval);
            document.removeEventListener('keydown', handleKeyPress);
            currentTest = null;
            securityViolated = false;
        });

        console.log('üõ°Ô∏è SecureTest Platform Loaded');
        console.log('Demo Admin: admin/admin123');
        console.log('Demo User: user001/pass123');
    </script>
</body>
</html>
